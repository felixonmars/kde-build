#!/bin/bash

. common

broken=''

arch=$1
[[ -z ${arch} ]] && arch=${CARCH}

if ${usechroot}; then
	echo -n 'creating clean working copy...'
	sudo mkdir -p "${chroot}/copy"
	sudo rsync -a --delete -q -W -x "${chroot}/root/" "${chroot}/copy"
fi

for i in ${depPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		if [ ${arch} = "i686" ]; then
			linux32 sudo makechrootpkg -r ${chroot} -- --noconfirm -iL || exit
		else
			if [ ${arch} = "x86_64" ]; then
				sudo makechrootpkg -r ${chroot} -- --noconfirm -iL || exit
			fi
		fi
	else
		makepkg -isL --noconfirm || exit 1
	fi
	_popd
done

[[ ${installall} ]] && OPTS="-i"
for i in ${optPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		[[ ${arch} = "i686" ]] && linux32 sudo makechrootpkg -r ${chroot} -- --noconfirm ${OPTS} -L || broken="${broken} ${i}"
		[[ ${arch} = "x86_64" ]] && sudo makechrootpkg -r ${chroot} -- --noconfirm ${OPTS} -L || broken="${broken} ${i}"
	else
		makepkg -sL ${OPTS} --noconfirm || broken="${broken} ${i}"
	fi
	_popd
done

if [ "${broken}" != "" ]; then
	echo "Broken packages: ${broken}"
fi
