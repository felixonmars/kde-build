#!/bin/bash

. common

broken=''

arch=$1
[[ -z $arch ]] && arch=$CARCH

for i in ${depPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		[[ $arch == "i686" ]] && linux32 sudo makechrootpkg -u -d -r ${chroot} -- --noconfirm || exit 1
		[[ $arch == "x86_64" ]] && sudo makechrootpkg -u -d -r ${chroot} -- --noconfirm || exit 1
	else
		makepkg -isL --noconfirm || exit 1
	fi
	_popd
done

for i in ${optPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		if ${installall}; then
			[[ $arch == "i686" ]] && linux32 sudo makechrootpkg -u -d -r ${chroot} -- --noconfirm || exit 1
			[[ $arch == "x86_64" ]] && sudo makechrootpkg -u -d -r ${chroot} -- --noconfirm || exit 1
		else
			sudo makechrootpkg -u -r ${chroot} -- --noconfirm || broken="${broken} ${i}"
		fi
	else
		makepkg -$(${installall} && echo 'i')sL --noconfirm || broken="${broken} ${i}"
	fi
	_popd
done

if [ "${broken}" != "" ]; then
	echo "Broken packages: ${broken}"
fi
