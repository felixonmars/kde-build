#!/bin/bash

. common

broken=''
MAKEPKG_OPTS="--noconfirm -iL"

# Pass i686 as argument if you want to build i686 packages on a x86_64 system
arch=$1
[[ -z ${arch} ]] && arch=$(uname -m)

for i in ${depPkgName}; do
	_pushd build/${i}/${svnbranch}
	if [ "${i}" = "kdelibs" ]; then
		setarch ${arch} sudo makechrootpkg -u -c -r /var/tmp/archbuild/${repo}-${arch} -- ${MAKEPKG_OPTS} || exit 1
	else
		setarch ${arch} sudo makechrootpkg -r /var/tmp/archbuild/${repo}-${arch} -- ${MAKEPKG_OPTS} || exit 1
	 fi
	_popd
done

MAKEPKG_OPTS="--noconfirm -L"

for i in ${optPkgName}; do
	_pushd build/${i}/${svnbranch}
	setarch ${arch} sudo makechrootpkg -r /var/tmp/archbuild/${repo}-${arch} -- ${MAKEPKG_OPTS} || broken="${broken} ${i}"
	_popd
done

if ${l10n}; then
	_pushd build/kde-l10n/${svnbranch}
	setarch ${arch} sudo makechrootpkg -r /var/tmp/archbuild/${repo}-${arch} -- ${MAKEPKG_OPTS} || broken="${broken} ${i}"
	_popd
fi

if [ ! -z "${broken}" ]; then
	echo "Broken packages: ${broken}"
fi
