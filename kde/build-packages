#!/bin/bash

. common

broken=''
MAKEPKG_OPTS="--noconfirm -iL"

# Pass i686 as argument if you want to build i686 packages on a x86_64 system
arch=$1
[[ -z ${arch} ]] && arch=${CARCH}

if ${usechroot}; then
	echo -n 'creating clean working copy...'
	sudo mkdir -p "${chroot}/copy"
	sudo rsync -a --delete -q -W -x "${chroot}/root/" "${chroot}/copy"
fi

for i in ${depPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		if [ ${arch} = "i686" ]; then
			linux32 sudo makechrootpkg -r ${chroot} -- ${MAKEPKG_OPTS} || exit 1
		else
			if [ ${arch} = "x86_64" ]; then
				sudo makechrootpkg -r ${chroot} -- ${MAKEPKG_OPTS} || exit 1
			fi
		fi
	else
		makepkg -s ${MAKEPKG_OPTS} || exit 1
	fi
	_popd
done

if ! ${installall}; then
  MAKEPKG_OPTS="--noconfirm -L"
fi

for i in ${optPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		[[ ${arch} = "i686" ]] && linux32 sudo makechrootpkg -r ${chroot} -- ${MAKEPKG_OPTS} || broken="${broken} ${i}"
		[[ ${arch} = "x86_64" ]] && sudo makechrootpkg -r ${chroot} -- ${MAKEPKG_OPTS} || broken="${broken} ${i}"
	else
		makepkg -s ${MAKEPKG_OPTS} || broken="${broken} ${i}"
	fi
	_popd
done

if [ "${broken}" != "" ]; then
	echo "Broken packages: ${broken}"
fi
