#!/bin/bash

. common

broken=''

arch=$1
[[ -z ${arch} ]] && arch=${CARCH}

for i in ${depPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		if [ ${arch} = "i686" ]; then
			linux32 sudo makechrootpkg -u -d -r ${chroot} -- --noconfirm || exit
		else
			if [ ${arch} = "x86_64" ]; then
				sudo makechrootpkg -u -d -r ${chroot} -- --noconfirm || exit
			fi
		fi
	else
		makepkg -isL --noconfirm || exit 1
	fi
	_popd
done

[[ ${installall} ]] && OPTS="-d"
for i in ${optPkgName}; do
	_pushd build/${i}/${svnbranch}
	if ${usechroot}; then
		[[ ${arch} = "i686" ]] && linux32 sudo makechrootpkg -u ${OPTS} -r ${chroot} -- --noconfirm || broken="${broken} ${i}"
		[[ ${arch} = "x86_64" ]] && sudo makechrootpkg -u ${OPTS} -r ${chroot} -- --noconfirm || broken="${broken} ${i}"
	else
		makepkg -$(${installall} && echo 'i')sL --noconfirm || broken="${broken} ${i}"
	fi
	_popd
done

if [ "${broken}" != "" ]; then
	echo "Broken packages: ${broken}"
fi
